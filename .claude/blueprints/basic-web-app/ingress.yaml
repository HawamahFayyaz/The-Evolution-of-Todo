# ============================================================
# INGRESS - External HTTP(S) routing
# ============================================================
# Routes traffic from domain to services based on path:
#   /        -> frontend-service
#   /api/*   -> backend-service
#
# TLS/SSL via cert-manager (automatic Let's Encrypt)
# ============================================================

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{app.name}}-ingress
  namespace: {{app.namespace}}
  labels:
    app: {{app.name}}
  annotations:
    # ==================== NGINX Ingress Controller ====================
    kubernetes.io/ingress.class: "{{ingress.className}}"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"

    # Rate limiting (optional)
    # nginx.ingress.kubernetes.io/limit-rps: "100"
    # nginx.ingress.kubernetes.io/limit-connections: "50"

    # ==================== Cert-Manager (Let's Encrypt) ====================
    # Automatically provisions TLS certificates
    cert-manager.io/cluster-issuer: "{{ingress.tls.clusterIssuer}}"

    # ==================== AWS ALB (if using AWS) ====================
    # kubernetes.io/ingress.class: "alb"
    # alb.ingress.kubernetes.io/scheme: "internet-facing"
    # alb.ingress.kubernetes.io/target-type: "ip"
    # alb.ingress.kubernetes.io/certificate-arn: "arn:aws:acm:..."

    # ==================== GCP (if using GKE) ====================
    # kubernetes.io/ingress.class: "gce"
    # kubernetes.io/ingress.global-static-ip-name: "my-static-ip"

spec:
  ingressClassName: {{ingress.className}}

  # ==================== TLS Configuration ====================
  tls:
  - hosts:
    - {{ingress.host}}
    secretName: {{ingress.tls.secretName}}

  # ==================== Routing Rules ====================
  rules:
  - host: {{ingress.host}}
    http:
      paths:
      # Backend API routes
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: {{app.name}}-backend
            port:
              number: {{backend.port.service}}

      # Health check routes (if separate)
      - path: /health
        pathType: Exact
        backend:
          service:
            name: {{app.name}}-backend
            port:
              number: {{backend.port.service}}

      # Everything else goes to frontend
      - path: /
        pathType: Prefix
        backend:
          service:
            name: {{app.name}}-frontend
            port:
              number: {{frontend.port.service}}

---
# ==================== CERT-MANAGER CLUSTER ISSUER ====================
# Only needed once per cluster (not per app)
# Creates Let's Encrypt certificates automatically
# ============================================================
# apiVersion: cert-manager.io/v1
# kind: ClusterIssuer
# metadata:
#   name: letsencrypt-prod
# spec:
#   acme:
#     server: https://acme-v02.api.letsencrypt.org/directory
#     email: your-email@example.com
#     privateKeySecretRef:
#       name: letsencrypt-prod-key
#     solvers:
#     - http01:
#         ingress:
#           class: nginx
